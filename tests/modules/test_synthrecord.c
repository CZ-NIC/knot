/*  Copyright (C) 2019 CZ.NIC, z.s.p.o. <knot-dns@labs.nic.cz>

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */
#include <tap/basic.h>

#include <arpa/inet.h>

#include "stdio.h"

#include "knot/modules/synthrecord/utils.h"

void str_replace(char *dst, size_t n, const char from, const char to) {
    for(size_t i = 0; i < n; ++i) {
        if(dst[i] == from) {
            dst[i] = to;
        }
    }
}

void test_ip6_shortening(const char * const ips[], size_t n) {
    char buffer[INET6_ADDRSTRLEN];
	for(size_t i = 0; i < n; ++i) {
		if(!ips[i]) break;

        size_t len = synth_addr_cpy(buffer, ips[i], AF_INET6, true);
        str_replace(buffer, len, '-', ':');

        struct in6_addr original, converted;

		int ret = inet_pton(AF_INET6, ips[i], &original);
        if(ret != 1) continue;

        ret = inet_pton(AF_INET6, buffer, &converted);
        if(ret != 1) {
            ok(0, "'%s' -> '%s", ips[i], buffer);
            continue;
        }

        int result = true;
        for(int j = 0; j < 4; ++j) {
            result &= (original.__in6_u.__u6_addr32[j] == converted.__in6_u.__u6_addr32[j]);
            
        }
        ok(result, "'%s' -> '%s'", ips[i], buffer);   
    }
}


int main(int argc, char *argv[])
{
	plan_lazy();

    const char * const ipv6s[] = {
"7165:34D5:59B0:7BD6:7837:6422:8740:9BAA",
"20EF:5CBD:82D3:1303:C751:58D3:98D0:5D0E",
"C098:7B18:EFB5:7FBE:1F4C:0000:6C9F:CDDD",
"68BA:888A:2E81:23A9:1A37:10CD:B7EA:79EF",
"985D:B1BA:1BFC:0000:0000:344C:8771:0000",
"0000:86B0:E3D7:219D:693F:9447:0000:6045",
"A1CB:B4F5:1D23:BF0E:5BC1:0FA9:A61E:D8C3",
"90A9:DD38:CAEF:50EA:35CD:F7BE:E175:F630",
"FC5F:812F:2B01:6289:8951:0000:A2DB:0000",
"9D20:EE86:C71C:8484:7161:821E:0000:6557",

"41C9:0000:84E4:189C:7A56:A54E:0000:38B2",
"4660:7C78:CC02:649A:CD3C:0C87:8A16:F0AC",
"49BF:920F:0A67:08B3:FBE1:FF70:0060:059E",
"5EEC:A348:6BCF:B2D6:0746:DF9F:5FFE:BB4E",
"0000:0819:D199:F286:0000:6742:3275:9ADE",
"8004:0000:AE1A:0EAD:4CD4:C6C1:0000:4C29",
"0000:86BA:E56B:0A5C:CE60:4138:1179:FD6B",
"42CE:9EE5:0000:69E6:C895:9D20:202E:BE19",
"0E37:F749:0000:0DBC:5839:D73F:7D95:DB20",
"6CF3:C6FB:CFD6:8F9A:CEB6:5D14:076D:A953",

"D925:59FC:655B:0000:B703:4FD4:BF15:8CF1",
"8164:9308:FF1D:0889:925F:0000:ED3D:0B8B",
"53D0:FC3F:77B4:C019:2FA2:F1B9:84F1:0000",
"B011:F50E:0000:BAE0:B23C:8096:2CD9:B361",
"01FF:45C0:264E:526C:D950:E807:0000:4067",
"3DF6:D42B:D283:FE18:0000:0B3B:E955:34C3",
"7E83:1F36:EC96:520B:6D11:0000:0000:D77C",
"7C48:750C:B9D9:3C2A:6576:0000:0000:0000",
"3809:C68B:3C78:2037:0000:03EA:BFD9:BD22",
"5FD3:280F:4F67:F1A0:0D87:6FBF:9A40:0000",

"0000:E91D:2CD8:0000:0000:0000:0000:590B",
"0000:0000:0000:969B:0000:0000:0000:0000",
"C94C:C5C3:AFE7:D7D8:0000:F9C3:0000:0000",
"E0EF:5DAF:5B9F:0000:ACC8:D21B:C9AA:0000",
"0000:0000:DE78:B6A9:3B0D:0EE6:767C:C19F",
"0000:0000:7FB4:14CC:0000:0000:0000:6FCD",
"0000:0000:887D:0000:0000:C88B:037D:193E",
"251F:0000:C3F6:F46F:3C32:B5FA:3671:0000",
"4860:1C25:663A:0000:4D99:0000:B69C:3DF7",
"0000:0CF4:0000:0000:0000:13A3:0000:E9F4",

"1947:0B86:0000:0000:0000:A0F9:0000:2786",
"0000:0000:0000:0000:0176:0000:0000:0000",
"0000:0000:0000:0000:66E8:0000:0000:38E1",
"67CB:5F33:ECD5:62AC:8C4A:0000:C0EE:0000",
"0000:0000:1F1B:C339:0000:0000:0000:0000",
"0000:F281:D854:A50C:EB01:70A0:0000:0000",
"055C:0000:BA72:0000:697B:CAFA:DCE9:0000",
"0000:0000:0000:4259:0000:105E:0000:5398",
"F7F5:5590:4D9F:0000:0000:0000:0000:0000",
"E481:0FDD:0000:0000:A1B7:0000:0000:6A8C",

"0000:0000:4E83:0000:0000:0000:0000:9A53",
"0000:0000:F859:0000:891E:0000:0000:255F",
"0000:E7D9:0000:0000:0000:C438:0000:EA2C",
"0000:7761:0000:0000:74C8:0000:AA38:0000",
"0000:0000:0000:0000:BDF6:0000:80CA:B8FC",
"0000:3B87:6CE4:1413:0000:D09D:0000:0000",
"0000:0000:0000:D550:0000:BF38:0000:CD57",
"0000:7A10:0000:DB82:7B58:07D6:0000:8E81",
"0000:0000:0000:0000:489F:1C5F:C127:0000",
"11F8:76C1:0000:0000:49A2:0000:0000:0000",

"E727:0000:E290:0000:0000:0000:C55F:0000",
"7A90:1DE6:9925:B0F2:0000:0000:809D:0000",
"0000:0000:0000:0000:0000:0000:0000:0000",
"0000:B3A7:0000:571C:2FD8:EDF7:0000:0000",
"0000:0000:0000:0000:0000:0000:0000:6D6D",
"0000:0000:327C:0000:0000:A1D6:0000:0000",
"0000:0000:51B0:0000:0000:0000:0000:40AC",
"FAE1:6359:0000:0000:0000:209C:0000:0000",
"0000:0000:1085:0000:0000:0000:F244:EAEA",
"0000:4D66:3E9F:0000:0000:0000:0000:BE87",

"0000:0000:35EB:5C38:0000:0000:1230:0000",
"0000:0000:0000:0000:0000:0000:0000:0000",
"0000:0000:0000:0000:0000:0000:0000:0000",
"0000:0000:0000:B5B6:0000:0000:0000:0000",
"0000:0000:0000:B458:0000:B375:0000:0000",
"0000:0000:0000:0000:0000:55B4:0000:0000",
"9B54:0000:0000:0000:0000:0000:0000:0000",
"0000:4EEE:0000:0000:0000:0000:D1B7:EAB3",
"1E75:0000:0000:0000:0000:0000:0000:0000",
"0000:0000:0000:0000:0000:0000:0000:0000",

"0000:0000:0000:0000:0000:0000:0000:0000",
"0000:0000:0000:0000:0000:0000:0000:F6FD",
"0000:0000:0000:0000:0000:0000:0000:0000",
"9028:0000:0000:8549:6B4B:0000:0000:0000",
"0000:0000:DD0B:0000:0000:05F3:0000:0000",
"0000:0000:0000:0000:0000:0000:0000:393C",
"193A:0000:0000:0000:7BE2:0000:0000:0000",
"0000:0000:0000:0000:0000:0000:0000:0000",
"0000:0000:DB87:0000:0000:0000:0000:0000",
"0000:0000:0000:0000:0000:0000:0000:0000",

"0000:0000:0000:0000:0000:0000:0000:0000",

        NULL
    };
	
    test_ip6_shortening(ipv6s, sizeof(ipv6s)/sizeof(const char *));

	return 0;
}
